<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">{-|
== Aho-Corasick algorithm

The Aho-Corasick algorithm builds an automaton from a set of pattern strings, and then uses it to
find positions in a search string where each of the pattern strings occur.

This implementation only works on ByteStrings, to keep things fast. If required it can be adapted
to work on other sequence types.

A TrieAC a can be constructed from pattern strings with associated values a, which can be then be
turned into an ACRoot a. An ACRoot a can then be run on a search string to find matches.
Construction and matching are both lazy.

Sources:

* Alfred V. Aho and Margaret J. Corasick, &quot;Efficient string matching: An aid to bibliographic
  search&quot;, 1975
  https://dl.acm.org/doi/10.1145/360825.360855
* Stanford CS166 Aho-Corasick lecture slides
  https://web.stanford.edu/class/archive/cs/cs166/cs166.1166/lectures/04/Slides04.pdf

For complexities below, k is the alphabet range (max 256).

-}</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-comment">{-
Implementation notes:
* We have to be lazy in the (Maybe (ACNode a)) and the [a] in fromTrieAC because we build the tree
  depth-first and strictly (due to IntMap.Strict). If we could build it breadth-first, then we
  could be strict in these, but I don't see an easy way to do that.
-}</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">AhoCorasick</span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier">TrieAC</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="AhoCorasick.html#emptyTAC"><span class="hs-identifier">emptyTAC</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="AhoCorasick.html#insertTAC"><span class="hs-identifier">insertTAC</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="AhoCorasick.html#fromListTAC"><span class="hs-identifier">fromListTAC</span></a></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier">ACRoot</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="AhoCorasick.html#fromTrieAC"><span class="hs-identifier">fromTrieAC</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="AhoCorasick.html#matchAC"><span class="hs-identifier">matchAC</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.IntMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IM</span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">data</span><span> </span><span id="ACRoot"><span class="annot"><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier hs-var">ACRoot</span></a></span></span><span> </span><span id="local-6989586621679075498"><span class="annot"><a href="#local-6989586621679075498"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ACRoot"><span class="annot"><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier hs-var">ACRoot</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IM.IntMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075498"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679075498"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-53"></span><span class="hs-keyword">data</span><span> </span><span id="ACNode"><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-var">ACNode</span></a></span></span><span> </span><span id="local-6989586621679075495"><span class="annot"><a href="#local-6989586621679075495"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ACNode"><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-var">ACNode</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IM.IntMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679075495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-comment">-- | Builds an Aho-Corasick automaton from a trie. O(n), where n is the number of nodes in the trie.</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- This is not more than the total length of strings the trie was constructed with.</span><span>
</span><span id="line-57"></span><span id="local-6989586621679075443"><span class="annot"><a href="AhoCorasick.html#fromTrieAC"><span class="hs-identifier hs-type">fromTrieAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075443"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier hs-type">ACRoot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075443"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-58"></span><span id="fromTrieAC"><span class="annot"><span class="annottext">fromTrieAC :: TrieAC a -&gt; ACRoot a
</span><a href="AhoCorasick.html#fromTrieAC"><span class="hs-identifier hs-var hs-var">fromTrieAC</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span id="local-6989586621679075441"><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075441"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span id="local-6989586621679075440"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075440"><span class="hs-identifier hs-var">routs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a) -&gt; [a] -&gt; ACRoot a
forall a. IntMap (ACNode a) -&gt; [a] -&gt; ACRoot a
</span><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier hs-var">ACRoot</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075439"><span class="hs-identifier hs-var">rmp</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075440"><span class="hs-identifier hs-var">routs</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-59"></span><span>    </span><span id="local-6989586621679075439"><span class="annot"><span class="annottext">rmp :: IntMap (ACNode a)
</span><a href="#local-6989586621679075439"><span class="hs-identifier hs-var hs-var">rmp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TrieAC a -&gt; ACNode a) -&gt; IntMap (TrieAC a) -&gt; IntMap (ACNode a)
forall a b. (a -&gt; b) -&gt; IntMap a -&gt; IntMap b
</span><span class="hs-identifier hs-var">IM.map</span></span><span> </span><span class="annot"><span class="annottext">TrieAC a -&gt; ACNode a
</span><a href="#local-6989586621679075437"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075441"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span id="local-6989586621679075437"><span class="annot"><span class="annottext">go1 :: TrieAC a -&gt; ACNode a
</span><a href="#local-6989586621679075437"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span id="local-6989586621679075436"><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075436"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679075435"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075435"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a) -&gt; Maybe (ACNode a) -&gt; [a] -&gt; ACNode a
forall a. IntMap (ACNode a) -&gt; Maybe (ACNode a) -&gt; [a] -&gt; ACNode a
</span><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-var">ACNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Key -&gt; TrieAC a -&gt; ACNode a)
-&gt; IntMap (TrieAC a) -&gt; IntMap (ACNode a)
forall a b. (Key -&gt; a -&gt; b) -&gt; IntMap a -&gt; IntMap b
</span><span class="hs-identifier hs-var">IM.mapWithKey</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ACNode a) -&gt; Key -&gt; TrieAC a -&gt; ACNode a
</span><a href="#local-6989586621679075433"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075436"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075435"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075440"><span class="hs-identifier hs-var">routs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>    </span><span id="local-6989586621679075433"><span class="annot"><span class="annottext">go :: Maybe (ACNode a) -&gt; Key -&gt; TrieAC a -&gt; ACNode a
</span><a href="#local-6989586621679075433"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679075432"><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075432"><span class="hs-identifier hs-var">psuf</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679075431"><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621679075431"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span id="local-6989586621679075430"><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075430"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679075429"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075429"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a) -&gt; Maybe (ACNode a) -&gt; [a] -&gt; ACNode a
forall a. IntMap (ACNode a) -&gt; Maybe (ACNode a) -&gt; [a] -&gt; ACNode a
</span><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-var">ACNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Key -&gt; TrieAC a -&gt; ACNode a)
-&gt; IntMap (TrieAC a) -&gt; IntMap (ACNode a)
forall a b. (Key -&gt; a -&gt; b) -&gt; IntMap a -&gt; IntMap b
</span><span class="hs-identifier hs-var">IM.mapWithKey</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ACNode a) -&gt; Key -&gt; TrieAC a -&gt; ACNode a
</span><a href="#local-6989586621679075433"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075428"><span class="hs-identifier hs-var">suf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075430"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075428"><span class="hs-identifier hs-var">suf</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075427"><span class="hs-identifier hs-var">outs</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-62"></span><span>        </span><span id="local-6989586621679075428"><span class="annot"><span class="annottext">suf :: Maybe (ACNode a)
</span><a href="#local-6989586621679075428"><span class="hs-identifier hs-var hs-var">suf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a) -&gt; Maybe (ACNode a)
</span><a href="#local-6989586621679075426"><span class="hs-identifier hs-var">getSuf</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075432"><span class="hs-identifier hs-var">psuf</span></a></span><span>
</span><span id="line-63"></span><span>        </span><span id="local-6989586621679075426"><span class="annot"><span class="annottext">getSuf :: Maybe (ACNode a) -&gt; Maybe (ACNode a)
</span><a href="#local-6989586621679075426"><span class="hs-identifier hs-var hs-var">getSuf</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Key -&gt; IntMap (ACNode a) -&gt; Maybe (ACNode a)
forall a. Key -&gt; IntMap a -&gt; Maybe a
</span><span class="hs-identifier hs-var">IM.lookup</span></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621679075431"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075439"><span class="hs-identifier hs-var">rmp</span></a></span><span>
</span><span id="line-64"></span><span>        </span><span class="annot"><a href="#local-6989586621679075426"><span class="hs-identifier hs-var">getSuf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span id="local-6989586621679075424"><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075424"><span class="hs-identifier hs-var">mp'</span></a></span></span><span> </span><span id="local-6989586621679075423"><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075423"><span class="hs-identifier hs-var">suf'</span></a></span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Key -&gt; IntMap (ACNode a) -&gt; Maybe (ACNode a)
forall a. Key -&gt; IntMap a -&gt; Maybe a
</span><span class="hs-identifier hs-var">IM.lookup</span></span><span> </span><span class="annot"><span class="annottext">Key
</span><a href="#local-6989586621679075431"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075424"><span class="hs-identifier hs-var">mp'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a) -&gt; Maybe (ACNode a) -&gt; Maybe (ACNode a)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a) -&gt; Maybe (ACNode a)
</span><a href="#local-6989586621679075426"><span class="hs-identifier hs-var">getSuf</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075423"><span class="hs-identifier hs-var">suf'</span></a></span><span>
</span><span id="line-65"></span><span>        </span><span id="local-6989586621679075427"><span class="annot"><span class="annottext">outs :: [a]
</span><a href="#local-6989586621679075427"><span class="hs-identifier hs-var hs-var">outs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075429"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; (ACNode a -&gt; [a]) -&gt; Maybe (ACNode a) -&gt; [a]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075440"><span class="hs-identifier hs-var">routs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679075420"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075420"><span class="hs-identifier hs-var">outs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075420"><span class="hs-identifier hs-var">outs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075428"><span class="hs-identifier hs-var">suf</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-comment">-- | Returns a list of length (m + 1) where m is the length of the search string. This list contains a</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- list of pattern matches for every position in the string, including before the first character. A</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- match at a position is present as the associated value of the pattern string found to be ending at</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- that position.</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- O(m log k + z), where m is the length of the string and z is the total number of matches.</span><span>
</span><span id="line-72"></span><span id="local-6989586621679075419"><span class="annot"><a href="AhoCorasick.html#matchAC"><span class="hs-identifier hs-type">matchAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier hs-type">ACRoot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075419"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679075419"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span></span><span>
</span><span id="line-73"></span><span id="matchAC"><span class="annot"><span class="annottext">matchAC :: ACRoot a -&gt; ByteString -&gt; [[a]]
</span><a href="AhoCorasick.html#matchAC"><span class="hs-identifier hs-var hs-var">matchAC</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier hs-type">ACRoot</span></a></span><span> </span><span id="local-6989586621679075418"><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075418"><span class="hs-identifier hs-var">rmp</span></a></span></span><span> </span><span id="local-6989586621679075417"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075417"><span class="hs-identifier hs-var">routs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679075416"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075416"><span class="hs-identifier hs-var">s0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075417"><span class="hs-identifier hs-var">routs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [[a]] -&gt; [[a]]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [[a]]
</span><a href="#local-6989586621679075415"><span class="hs-identifier hs-var">gor</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075416"><span class="hs-identifier hs-var">s0</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-74"></span><span>    </span><span id="local-6989586621679075415"><span class="annot"><span class="annottext">gor :: ByteString -&gt; [[a]]
</span><a href="#local-6989586621679075415"><span class="hs-identifier hs-var hs-var">gor</span></a></span></span><span> </span><span id="local-6989586621679075414"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075414"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075414"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-75"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-76"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679075412"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679075412"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679075411"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075411"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Key -&gt; IntMap (ACNode a) -&gt; Maybe (ACNode a)
forall a. Key -&gt; IntMap a -&gt; Maybe a
</span><span class="hs-identifier hs-var">IM.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Key
forall a. Enum a =&gt; a -&gt; Key
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679075412"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075418"><span class="hs-identifier hs-var">rmp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-77"></span><span>            </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075417"><span class="hs-identifier hs-var">routs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [[a]] -&gt; [[a]]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [[a]]
</span><a href="#local-6989586621679075415"><span class="hs-identifier hs-var">gor</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075411"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-78"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span id="local-6989586621679075409"><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075409"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span id="local-6989586621679075408"><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075408"><span class="hs-identifier hs-var">suf</span></a></span></span><span> </span><span id="local-6989586621679075407"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075407"><span class="hs-identifier hs-var">outs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075407"><span class="hs-identifier hs-var">outs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [[a]] -&gt; [[a]]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a) -&gt; Maybe (ACNode a) -&gt; ByteString -&gt; [[a]]
</span><a href="#local-6989586621679075406"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075409"><span class="hs-identifier hs-var">mp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075408"><span class="hs-identifier hs-var">suf</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075411"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span id="local-6989586621679075406"><span class="annot"><span class="annottext">go :: IntMap (ACNode a) -&gt; Maybe (ACNode a) -&gt; ByteString -&gt; [[a]]
</span><a href="#local-6989586621679075406"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679075405"><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075405"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span id="local-6989586621679075404"><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075404"><span class="hs-identifier hs-var">suf</span></a></span></span><span> </span><span id="local-6989586621679075403"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075403"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075403"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-81"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679075402"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679075402"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679075401"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075401"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Key -&gt; IntMap (ACNode a) -&gt; Maybe (ACNode a)
forall a. Key -&gt; IntMap a -&gt; Maybe a
</span><span class="hs-identifier hs-var">IM.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Key
forall a. Enum a =&gt; a -&gt; Key
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679075402"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075405"><span class="hs-identifier hs-var">mp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-82"></span><span>            </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; [[a]])
-&gt; (ACNode a -&gt; ByteString -&gt; [[a]])
-&gt; Maybe (ACNode a)
-&gt; ByteString
-&gt; [[a]]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [[a]]
</span><a href="#local-6989586621679075415"><span class="hs-identifier hs-var">gor</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span id="local-6989586621679075400"><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075400"><span class="hs-identifier hs-var">mp'</span></a></span></span><span> </span><span id="local-6989586621679075399"><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075399"><span class="hs-identifier hs-var">suf'</span></a></span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a) -&gt; Maybe (ACNode a) -&gt; ByteString -&gt; [[a]]
</span><a href="#local-6989586621679075406"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075400"><span class="hs-identifier hs-var">mp'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075399"><span class="hs-identifier hs-var">suf'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075404"><span class="hs-identifier hs-var">suf</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075403"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-83"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span id="local-6989586621679075398"><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075398"><span class="hs-identifier hs-var">mp'</span></a></span></span><span> </span><span id="local-6989586621679075397"><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075397"><span class="hs-identifier hs-var">suf'</span></a></span></span><span> </span><span id="local-6989586621679075396"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075396"><span class="hs-identifier hs-var">outs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075396"><span class="hs-identifier hs-var">outs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [[a]] -&gt; [[a]]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a) -&gt; Maybe (ACNode a) -&gt; ByteString -&gt; [[a]]
</span><a href="#local-6989586621679075406"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075398"><span class="hs-identifier hs-var">mp'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075397"><span class="hs-identifier hs-var">suf'</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075401"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-keyword">data</span><span> </span><span id="TrieAC"><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-var">TrieAC</span></a></span></span><span> </span><span id="local-6989586621679075475"><span class="annot"><a href="#local-6989586621679075475"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TrieAC"><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-var">TrieAC</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IM.IntMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075475"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679075475"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679075390"><span id="local-6989586621679075392"><span id="local-6989586621679075394"><span class="annot"><span class="annottext">Key -&gt; TrieAC a -&gt; ShowS
[TrieAC a] -&gt; ShowS
TrieAC a -&gt; String
(Key -&gt; TrieAC a -&gt; ShowS)
-&gt; (TrieAC a -&gt; String) -&gt; ([TrieAC a] -&gt; ShowS) -&gt; Show (TrieAC a)
forall a. Show a =&gt; Key -&gt; TrieAC a -&gt; ShowS
forall a. Show a =&gt; [TrieAC a] -&gt; ShowS
forall a. Show a =&gt; TrieAC a -&gt; String
forall a.
(Key -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [TrieAC a] -&gt; ShowS
$cshowList :: forall a. Show a =&gt; [TrieAC a] -&gt; ShowS
show :: TrieAC a -&gt; String
$cshow :: forall a. Show a =&gt; TrieAC a -&gt; String
showsPrec :: Key -&gt; TrieAC a -&gt; ShowS
$cshowsPrec :: forall a. Show a =&gt; Key -&gt; TrieAC a -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">-- | An empty trie.</span><span>
</span><span id="line-88"></span><span id="local-6989586621679075464"><span class="annot"><a href="AhoCorasick.html#emptyTAC"><span class="hs-identifier hs-type">emptyTAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075464"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-89"></span><span id="emptyTAC"><span class="annot"><span class="annottext">emptyTAC :: TrieAC a
</span><a href="AhoCorasick.html#emptyTAC"><span class="hs-identifier hs-var hs-var">emptyTAC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a) -&gt; [a] -&gt; TrieAC a
forall a. IntMap (TrieAC a) -&gt; [a] -&gt; TrieAC a
</span><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-var">TrieAC</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a)
forall a. IntMap a
</span><span class="hs-identifier hs-var">IM.empty</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">-- | Inserts a string with an associated value into a trie. O(n log k) where n is the length of the</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- string.</span><span>
</span><span id="line-93"></span><span id="local-6989586621679075457"><span class="annot"><a href="AhoCorasick.html#insertTAC"><span class="hs-identifier hs-type">insertTAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679075457"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075457"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075457"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-94"></span><span id="insertTAC"><span class="annot"><span class="annottext">insertTAC :: ByteString -&gt; a -&gt; TrieAC a -&gt; TrieAC a
</span><a href="AhoCorasick.html#insertTAC"><span class="hs-identifier hs-var hs-var">insertTAC</span></a></span></span><span> </span><span id="local-6989586621679075387"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075387"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679075386"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679075386"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; TrieAC a -&gt; TrieAC a
</span><a href="#local-6989586621679075385"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075387"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-95"></span><span>    </span><span id="local-6989586621679075385"><span class="annot"><span class="annottext">go :: ByteString -&gt; TrieAC a -&gt; TrieAC a
</span><a href="#local-6989586621679075385"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679075384"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075384"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span id="local-6989586621679075383"><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075383"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679075382"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075382"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">B.uncons</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075384"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-96"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Word8, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a) -&gt; [a] -&gt; TrieAC a
forall a. IntMap (TrieAC a) -&gt; [a] -&gt; TrieAC a
</span><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-var">TrieAC</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075383"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679075386"><span class="hs-identifier hs-var">v</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075382"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679075381"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679075381"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679075380"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075380"><span class="hs-identifier hs-var">cs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a) -&gt; [a] -&gt; TrieAC a
forall a. IntMap (TrieAC a) -&gt; [a] -&gt; TrieAC a
</span><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-var">TrieAC</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075379"><span class="hs-identifier hs-var">m'</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075382"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-98"></span><span>            </span><span id="local-6989586621679075379"><span class="annot"><span class="annottext">m' :: IntMap (TrieAC a)
</span><a href="#local-6989586621679075379"><span class="hs-identifier hs-var hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe (TrieAC a) -&gt; Maybe (TrieAC a))
-&gt; Key -&gt; IntMap (TrieAC a) -&gt; IntMap (TrieAC a)
forall a. (Maybe a -&gt; Maybe a) -&gt; Key -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">IM.alter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrieAC a -&gt; Maybe (TrieAC a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TrieAC a -&gt; Maybe (TrieAC a)) -&gt; TrieAC a -&gt; Maybe (TrieAC a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TrieAC a -&gt; Maybe (TrieAC a))
-&gt; (Maybe (TrieAC a) -&gt; TrieAC a)
-&gt; Maybe (TrieAC a)
-&gt; Maybe (TrieAC a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; TrieAC a -&gt; TrieAC a
</span><a href="#local-6989586621679075385"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075380"><span class="hs-identifier hs-var">cs'</span></a></span><span> </span><span class="annot"><span class="annottext">(TrieAC a -&gt; TrieAC a)
-&gt; (Maybe (TrieAC a) -&gt; TrieAC a) -&gt; Maybe (TrieAC a) -&gt; TrieAC a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TrieAC a -&gt; Maybe (TrieAC a) -&gt; TrieAC a
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">TrieAC a
forall a. TrieAC a
</span><a href="AhoCorasick.html#emptyTAC"><span class="hs-identifier hs-var">emptyTAC</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Key
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679075381"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntMap (TrieAC a)
</span><a href="#local-6989586621679075383"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | Builds a trie from a list of strings and associated values. O(n log k) where n is total length of</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- the strings.</span><span>
</span><span id="line-102"></span><span id="local-6989586621679075374"><span class="annot"><a href="AhoCorasick.html#fromListTAC"><span class="hs-identifier hs-type">fromListTAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679075374"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="AhoCorasick.html#TrieAC"><span class="hs-identifier hs-type">TrieAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075374"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-103"></span><span id="fromListTAC"><span class="annot"><span class="annottext">fromListTAC :: [(ByteString, a)] -&gt; TrieAC a
</span><a href="AhoCorasick.html#fromListTAC"><span class="hs-identifier hs-var hs-var">fromListTAC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TrieAC a -&gt; (ByteString, a) -&gt; TrieAC a)
-&gt; TrieAC a -&gt; [(ByteString, a)] -&gt; TrieAC a
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679075372"><span class="annot"><span class="annottext">TrieAC a
</span><a href="#local-6989586621679075372"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679075371"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075371"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679075370"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679075370"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; a -&gt; TrieAC a -&gt; TrieAC a
forall a. ByteString -&gt; a -&gt; TrieAC a -&gt; TrieAC a
</span><a href="AhoCorasick.html#insertTAC"><span class="hs-identifier hs-var">insertTAC</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679075371"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679075370"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TrieAC a
</span><a href="#local-6989586621679075372"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TrieAC a
forall a. TrieAC a
</span><a href="AhoCorasick.html#emptyTAC"><span class="hs-identifier hs-var">emptyTAC</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- For tests</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span id="local-6989586621679075369"><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="#local-6989586621679075369"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075369"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621679075366"><span class="annot"><span class="annottext">rnf :: ACNode a -&gt; ()
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">rnf</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACNode"><span class="hs-identifier hs-type">ACNode</span></a></span><span> </span><span id="local-6989586621679075364"><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075364"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span id="local-6989586621679075363"><span class="annot"><span class="annottext">Maybe (ACNode a)
</span><a href="#local-6989586621679075363"><span class="hs-identifier hs-var">_outs</span></a></span></span><span> </span><span id="local-6989586621679075362"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075362"><span class="hs-identifier hs-var">suf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075362"><span class="hs-identifier hs-var">suf</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; () -&gt; ()
</span><span class="hs-operator hs-var">`seq`</span></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a) -&gt; ()
forall a. NFData a =&gt; a -&gt; ()
</span><span class="hs-identifier hs-var">rnf</span></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075364"><span class="hs-identifier hs-var">mp</span></a></span></span><span>
</span><span id="line-110"></span><span class="hs-comment">-- outs of nodes share structure, so it is not forced</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- the suf link is forced only to WHNF, otherwise it would be reevaluating various parts of the tree</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span id="local-6989586621679075361"><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="#local-6989586621679075361"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier hs-type">ACRoot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679075361"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-114"></span><span>    </span><span id="local-6989586621679075359"><span class="annot"><span class="annottext">rnf :: ACRoot a -&gt; ()
</span><a href="#local-6989586621679075359"><span class="hs-identifier hs-var hs-var hs-var hs-var">rnf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="AhoCorasick.html#ACRoot"><span class="hs-identifier hs-type">ACRoot</span></a></span><span> </span><span id="local-6989586621679075358"><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075358"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span id="local-6989586621679075357"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679075357"><span class="hs-identifier hs-var">_outs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a) -&gt; ()
forall a. NFData a =&gt; a -&gt; ()
</span><span class="hs-identifier hs-var">rnf</span></span><span> </span><span class="annot"><span class="annottext">IntMap (ACNode a)
</span><a href="#local-6989586621679075358"><span class="hs-identifier hs-var">mp</span></a></span></span><span>
</span><span id="line-115"></span></pre></body></html>